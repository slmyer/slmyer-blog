---
title: 'React Suspense ä¸ lazy'
author: 'slmyer'
date: '2025/02/18 14:11:30'
tags: ['React']
summary: 'React Suspense ä¸ lazy'
---

## å‰è¨€

ç”±äºä¹‹å‰åœ¨çœ‹ `React` æ–°çš„å˜åŒ–æ—¶ï¼Œæ³¨æ„åˆ°å…³äº `use` å¸¦æ¥çš„ä¸€äº›æ”¹å˜ï¼ˆä¹‹å‰åœ¨ç”¨ `Suspense` å»åšç»„ä»¶çš„å¼‚æ­¥åŠ è½½ä½¿ç”¨åˆ°äº†ä¸€äº› `hack` å†™æ³•ï¼‰ã€‚
ä¸ºäº†æ›´å¥½çš„ç†è§£ `React` åº•å±‚æœºåˆ¶å’Œå®é™…åº”ç”¨ï¼Œæœ¬æ–‡å°†å¯¹ `Suspense` ä¸ `lazy` çš„åŸºæœ¬ç”¨æ³•è¿›è¡Œä»‹ç»ï¼ŒåŒæ—¶å‰–æä¸‹å†…éƒ¨å®ç°åŸç†ï¼ŒåŒ…æ‹¬é”™è¯¯æ•è·ã€çŠ¶æ€ç®¡ç†åŠé‡æ¸²æŸ“æµç¨‹ã€‚

> æœ¬æ–‡ä»£ç å…¨éƒ¨åŸºäº React æœ€æ–°ç‰ˆæœ¬ **V19.0.0**ï¼Œä¸ä¹‹å‰ V18+ å¯èƒ½å­˜åœ¨å·®å¼‚ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹ [React](https://github.com/facebook/react) æ–§æ­£ã€‚

## Suspense

### åŸºæœ¬æ¦‚å¿µä¸ç”¨æ³•

`Suspense` åœ¨ `React` å®˜ç½‘å®šä¹‰æ˜¯ **Suspense å…è®¸åœ¨å­ç»„ä»¶å®ŒæˆåŠ è½½å‰å±•ç¤ºåå¤‡æ–¹æ¡ˆ**ï¼Œå¸¸è§ç”¨æ³•æ˜¯ä½¿ç”¨ `lazy` ï¼Œå»åšå¼‚æ­¥ç»„ä»¶çš„åŠ è½½ã€‚ä¾‹å¦‚ï¼š

```ts
import { Suspense, lazy } from "react"

const LazyComponent = lazy(() => import("./SomeComponent"))

const App = () => {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <LazyComponent />
    </Suspense>
  )
}
```

åœ¨è€ç‰ˆæœ¬ `React` ä¸­ï¼Œå¦‚æœä½ è¦ä½¿ç”¨ `Suspense` å»åšæ¥å£å±‚é¢çš„å¤„ç†ï¼Œæ¯”å¦‚ä½ éœ€è¦åœ¨æ¥å£è¿”å›ä¹‹åå±•ç¤ºçœŸå® UIï¼Œè¿™æ—¶å€™ä½ æˆ–è®¸éœ€è¦ä¸€äº› `hack` å†™æ³•ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯è¿™å¹¶ä¸æ˜¯æ¨èè¡Œä¸ºï¼š

> `Suspense` çš„ä½œç”¨æ˜¯ä¸ºäº†ç»Ÿä¸€å¤„ç†å¼‚æ­¥åŠ è½½ï¼Œè€Œä¸æ˜¯ä»…ä»…å¤„ç† `lazy` ä½œç”¨äºä»£ç åˆ†å‰²ï¼Œå°†å¼‚æ­¥çŠ¶æ€æ”¶å£åˆ°æ¡†æ¶æœ¬èº«æ˜¯å…¶æœ€ç»ˆç›®çš„ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ[^1]ã€‚

### å¼‚æ­¥æ¨¡æ‹Ÿ

ä¸‹æ–¹æ˜¯çš„ä¾‹å­æ˜¯é€šè¿‡æ¨¡æ‹Ÿ `lazy` æœ¬èº«çš„è¡Œä¸ºï¼Œå®Œæˆæ¥å£æ•°æ®çš„è·å–ï¼Œå¹¶å°†æ•°æ®é€šè¿‡ `props` è¿›è¡Œä¼ é€’ï¼š

```ts
// æ¨¡æ‹Ÿå¼‚æ­¥æ•°æ®è¯·æ±‚
function fetchData() {
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve({ message: "Hello from API" });
    }, 2000);
  });
}

// ä½¿ç”¨ lazy è¿›è¡ŒåŠ¨æ€åŠ è½½ï¼Œå¹¶å°†æ•°æ®ä½œä¸º props ä¼ é€’
const Component = lazy(() =>
  fetchData().then((data) => ({
    default: () => <SomeComponent data={data} />,
  }))
);

```

å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ `throw` çš„å½¢å¼ï¼Œå»æ¨¡æ‹Ÿ `lazy` çš„å¼‚å¸¸è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š

```ts
function wrapPromise<T>(promise: Promise<T>) {
  let status = 'pending'
  let result: T
  let suspender = promise.then(
    (r) => {
      status = 'success'
      result = r
    },
    (e) => {
      status = 'error'
      result = e
    }
  )

  return {
    read() {
      if (status === 'pending') throw suspender
      if (status === 'error') throw result
      return result
    },
  }
}
```

ä¸è¿‡ä¸Šé¢é‚£äº›æ¨¡æ‹Ÿçš„è¡Œä¸ºï¼Œåœ¨æœ€æ–°ç‰ˆæœ¬ä¸­éƒ½å¾—ä»¥æ”¹å–„ï¼Œä½ å¯ä»¥é€šè¿‡æœ€æ–°çš„ API `use` æ¥å®Œæˆæ•°æ®çš„è·å–ä»¥åŠå¼‚å¸¸æ—¶é‡å¯è°ƒåº¦è¡Œä¸ºï¼Œå…·ä½“è¯·å‚è€ƒå‚è€ƒ `use` çš„å®˜æ–¹è¯´æ˜[^2]ï¼š

> `use` å®ƒå¯ä»¥ç”¨æ¥è¯»å– `Promise` æˆ–è€… `context` çš„å€¼ï¼Œä¸ `Hooks` çš„åŒºåˆ«æ˜¯ï¼Œå®ƒå¯ä»¥æ”¾å…¥å¾ªç¯ä¸æ¡ä»¶è¯­å¥ï¼Œä½†æ˜¯å¿…é¡»åœ¨ `Hooks` ä¸ç»„ä»¶å†…ä½¿ç”¨ï¼Œä¸”è¦æ³¨æ„çš„æ˜¯ï¼Œä½ éœ€è¦ä¿è¯ `Promise` çš„**å”¯ä¸€æ€§**ã€‚

```ts
import { Suspense, use } from 'react'

const InnerComponent = ({ promise }) => {
  const message = use(promise)
  return <>message is {message}</>
}
```

### Suspense å†…éƒ¨å®ç°

#### å·¥ä½œæµç¨‹æ¦‚è¿°

ä»å†…éƒ¨å®ç°æ¥çœ‹ï¼Œ`Suspense` çš„å·¥ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

##### 1. åˆæ¬¡æ¸²æŸ“æ—¶

å­ç»„ä»¶å› å¼‚æ­¥åŠ è½½è€Œè§¦å‘å¼‚å¸¸ï¼ˆé€šè¿‡ `throw Promise`ï¼‰ï¼Œæ­¤æ—¶ `Suspense` æ•è·è¯¥å¼‚å¸¸å¹¶å±•ç¤º `Fallback` UIã€‚

##### 2. å¼‚æ­¥åŠ è½½å®Œæˆ

å½“ `Promise` å®Œæˆåï¼Œ`React` é‡æ–°è°ƒåº¦æ¸²æŸ“ï¼Œæ›¿æ¢ä¸ºçœŸå® UIã€‚

åœ¨ `Suspense` å†…éƒ¨å®ç°å°±æ˜¯é€šè¿‡ `showFallback` æ¥è¿›è¡Œæ§åˆ¶çš„ï¼Œå…·ä½“ä»£ç åœ¨ <mark>ReactFiberBeginWork.js</mark> ä¸­ï¼š

```ts filename="ReactFiberBeginWork.js"
function updateSuspenseComponent(current: null | Fiber, workInProgress: Fiber, renderLanes: Lanes) {
  const nextProps = workInProgress.pendingProps

  let showFallback = false
  const didSuspend = (workInProgress.flags & DidCapture) !== NoFlags
  if (didSuspend || shouldRemainOnFallback(current, workInProgress, renderLanes)) {
    showFallback = true
    workInProgress.flags &= ~DidCapture
  }

  const didPrimaryChildrenDefer = (workInProgress.flags & DidDefer) !== NoFlags
  workInProgress.flags &= ~DidDefer

  if (current === null) {
    // æŒ‚è½½æµç¨‹
    const nextPrimaryChildren = nextProps.children
    const nextFallbackChildren = nextProps.fallback
    if (showFallback) {
      const fallbackFragment = mountSuspenseFallbackChildren(
        workInProgress,
        nextPrimaryChildren,
        nextFallbackChildren,
        renderLanes
      )
      return fallbackFragment
    } else {
      return mountSuspensePrimaryChildren(workInProgress, nextPrimaryChildren, renderLanes)
    }
  } else {
    // æ›´æ–°æµç¨‹
    if (showFallback) {
      const nextFallbackChildren = nextProps.fallback
      const nextPrimaryChildren = nextProps.children
      const fallbackChildFragment = updateSuspenseFallbackChildren(
        current,
        workInProgress,
        nextPrimaryChildren,
        nextFallbackChildren,
        renderLanes
      )
      return fallbackChildFragment
    } else {
      const nextPrimaryChildren = nextProps.children
      const primaryChildFragment = updateSuspensePrimaryChildren(
        current,
        workInProgress,
        nextPrimaryChildren,
        renderLanes
      )
      workInProgress.memoizedState = null
      return primaryChildFragment
    }
  }
}
```

#### å¼‚å¸¸æ•è·ä¸é‡æ–°è°ƒåº¦

é‚£ä¹ˆ `React` å†…éƒ¨æ˜¯æ€ä¹ˆå®Œæˆ `showFallback` çš„åˆ‡æ¢çš„å‘¢ï¼Ÿï¼Œæ˜¯é€šè¿‡å¼‚å¸¸å¤„ç†æœºåˆ¶æ¥æ•è· `throw` æŠ›å‡ºçš„ `Promise`ï¼Œæœ€ç»ˆåœ¨ `Promise` å®ŒæˆåŠ è½½æ—¶ï¼Œæ˜¾ç¤ºçœŸå®çš„ UIã€‚å…·ä½“å¯ä»¥å‚è€ƒ <mark>ReactFiberWorkLoop.js</mark> ä¸­çš„ `handleThrow`ï¼š

```ts filename="ReactFiberWorkLoop.js"
outer: do {
  try {
    if (workInProgressSuspendedReason !== NotSuspended && workInProgress !== null) {
      const unitOfWork = workInProgress
      const thrownValue = workInProgressThrownValue
      resumeOrUnwind: switch (workInProgressSuspendedReason) {
        // çœç•¥ä»£ç 
        case SuspendedOnDeprecatedThrowPromise: {
          workInProgressSuspendedReason = NotSuspended
          workInProgressThrownValue = null
          throwAndUnwindWorkLoop(root, unitOfWork, thrownValue, SuspendedOnDeprecatedThrowPromise)
          break
        }
        // çœç•¥ä»£ç 
      }
    }
    // çœç•¥ä»£ç 
    workLoopConcurrent() // ğŸ‘ˆ ä½¿ç”¨ Suspense èŠ‚ç‚¹é‡æ–°å¼€å§‹ beginWork
    break
  } catch (thrownValue) {
    handleThrow(root, thrownValue) // ğŸ‘ˆ catch throw promise
  }
} while (true)
```

è€Œ `handleThrow` å†…éƒ¨åˆ™æ˜¯é€šè¿‡åˆ¤æ–­ `thrownValue` æ¥è¿›è¡Œ `workInProgressSuspendedReason` çš„èµ‹å€¼æ“ä½œï¼Œåœ¨ `workLoop` æµç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° `workInProgressSuspendedReason` çš„ç›¸åº”å¤„ç†ã€‚

```ts filename="ReactFiberWorkLoop.js"
function handleThrow(root: FiberRoot, thrownValue: any): void {
  // çœç•¥ä»£ç 

  const isWakeable =
    thrownValue !== null &&
    typeof thrownValue === 'object' &&
    typeof thrownValue.then === 'function'

  workInProgressSuspendedReason = isWakeable ? SuspendedOnDeprecatedThrowPromise : SuspendedOnError // ğŸ‘ˆ ä½œä¸ºåç»­ä¾æ®å»èµ° throwAndUnwindWorkLoop æµç¨‹

  workInProgressThrownValue = thrownValue

  // çœç•¥ä»£ç 
}
```

`throwAndUnwindWorkLoop` å†…éƒ¨å®Œæˆäº†ä¸‰ä»¶äº‹ï¼š

1. `Suspense` `Fiber` èŠ‚ç‚¹çš„ `flags` æ ‡è®°ï¼ˆ `ShouldCapture` ï¼‰ï¼Œä½œä¸º `Fallback` åˆ‡æ¢çš„æ ‡å¿—ä½ï¼›
2. è°ƒåº¦æµç¨‹çš„é‡æ–°å‘èµ·å‘èµ·ï¼›
3. å®Œæˆ `Fiber` æ ‘çš„ `flags` åˆå¹¶ï¼›

```ts
// ReactFiberWorkLoop.js
function throwAndUnwindWorkLoop(
  root: FiberRoot,
  unitOfWork: Fiber,
  thrownValue: mixed,
  suspendedReason: SuspendedReason
) {
  const returnFiber = unitOfWork.return
  try {
    const didFatal = throwException(
      root,
      returnFiber,
      unitOfWork,
      thrownValue,
      workInProgressRootRenderLanes
    )
  } catch (error) {}

  if (unitOfWork.flags & Incomplete) {
    unwindUnitOfWork(unitOfWork, skipSiblings) // ğŸ‘ˆ ä» throw èŠ‚ç‚¹å‘ä¸Šåˆ°æœ€è¿‘çš„ Suspense Fiber èŠ‚ç‚¹ï¼Œå®Œæˆ flags åˆå¹¶å·¥ä½œ
  } else {
    completeUnitOfWork(unitOfWork)
  }
}

// ReactFiberThrow.js
function throwException(
  root: FiberRoot,
  returnFiber: Fiber | null,
  sourceFiber: Fiber,
  value: mixed,
  rootRenderLanes: Lanes
): boolean {
  sourceFiber.flags |= Incomplete

  if (value !== null && typeof value === 'object') {
    if (typeof value.then === 'function') {
      const wakeable: Wakeable = (value: any)

      const suspenseBoundary = getSuspenseHandler()
      if (suspenseBoundary !== null) {
        switch (suspenseBoundary.tag) {
          case SuspenseComponent: {
            markSuspenseBoundaryShouldCapture( // ğŸ‘ˆ ShouldCapture flags æ ‡è®°
              suspenseBoundary,
              returnFiber,
              sourceFiber,
              root,
              rootRenderLanes,
            );
            // çœç•¥
            const retryQueue: RetryQueue | null = (suspenseBoundary.updateQueue: any)
            if (retryQueue === null) {
              suspenseBoundary.updateQueue = new Set([wakeable])
            } else {
              retryQueue.add(wakeable)
            }

            if (disableLegacyMode || suspenseBoundary.mode & ConcurrentMode) {
              attachPingListener(root, wakeable, rootRenderLanes) // ğŸ‘ˆ é‡å¯è°ƒåº¦æµç¨‹
            }
            return false
          }
        }
      } else {
        // çœç•¥
      }
    }
  }

  return false
}
```

æœ€åï¼Œå¯ä»¥ç”¨ä¸€ä¸ªåºåˆ—å›¾æ¥æè¿°è¿™ä¸ªè¿‡ç¨‹ï¼š

1. åˆæ¬¡æ¸²æŸ“æ—¶ï¼Œ`Suspense` åŠ è½½ç»„ä»¶ï¼Œè¿™æ—¶å€™ç»„ä»¶ç”±äºå¼‚æ­¥åŠ è½½ `throw Promise` å»èµ°å¼‚å¸¸æµç¨‹ï¼›
2. `React` æ•è·åˆ°å¼‚å¸¸æµç¨‹ä¹‹åå¼€å§‹ `flags` æ ‡è®°ã€é‡æ–°è°ƒåº¦ï¼›
3. é‡æ–°è°ƒåº¦ä¹‹åå®Œæˆ `Fallback` ç»„ä»¶çš„å±•ç¤ºï¼›
4. å¼‚æ­¥ç»„ä»¶åŠ è½½å®Œæˆï¼Œåˆ‡æ¢çœŸå®çš„ UIï¼›

```mermaid

sequenceDiagram
  participant App as åº”ç”¨æ ¹èŠ‚ç‚¹
  participant S as Suspense
  participant C as åŠ¨æ€ç»„ä»¶
  participant P as Promise

  App->>S: åˆå§‹æ¸²æŸ“
  S->>C: å°è¯•æ¸²æŸ“å­ç»„ä»¶
  C->>P: å‘èµ·å¼‚æ­¥è¯·æ±‚
  P->>C: æŠ›å‡ºæœªå®Œæˆ Promise
  S->>S: æ•è·å¼‚å¸¸ï¼Œæ ‡è®° DidCapture
  S->>App: è¿”å› fallback UI
  P->>P: è¯·æ±‚å®Œæˆ
  App->>S: é‡æ–°æ¸²æŸ“
  S->>C: å†æ¬¡å°è¯•æ¸²æŸ“
  C->>S: è¿”å›æœ‰æ•ˆå†…å®¹
  S->>App: æäº¤æœ€ç»ˆ UI
```

## lazy

### å†…éƒ¨å®ç°

`lazy` æ¥å—ä¸€ä¸ªè¿”å› `Promise` æˆ–è€… `thenable` å‡½æ•°ï¼Œå®ƒçš„å¸¸ç”¨åœºæ™¯å°±æ˜¯æ­é… `import` åŠ¨æ€å¯¼å…¥ï¼Œæ¥å®ç°ä»£ç åˆ†å‰²ï¼Œå¹¶åˆ©ç”¨ `Suspense` æ¥å¤„ç†åŠ è½½çŠ¶æ€ã€‚
åœ¨å…¶å†…éƒ¨å®ç°ä¸­ï¼Œå¯ä»¥è®¤ä¸ºå®ƒç±»ä¼¼äºä¸€ä¸ªçŠ¶æ€æœºï¼Œæ ¹æ®åŠ è½½è¿›åº¦åˆ‡æ¢ä¸åŒçš„çŠ¶æ€æ¥ç®¡ç†ç»„ä»¶åŠ è½½çš„è¿‡ç¨‹ã€‚

#### 1. æ ¸å¿ƒç»“æ„

```js filename="ReactLazy.js"
function lazy<T>(
  ctor: () => Thenable<{default: T, ...}>,
): LazyComponent<T, Payload<T>> {
  const payload: Payload<T> = {
    _status: Uninitialized,
    _result: ctor,
  };

  const lazyType: LazyComponent<T, Payload<T>> = {
    $$typeof: REACT_LAZY_TYPE,
    _payload: payload,
    _init: lazyInitializer,
  };

  return lazyType;
}
```

#### 2. çŠ¶æ€æœºåˆ¶

```js filename="ReactLazy.js"
const Uninitialized = -1
const Pending = 0
const Resolved = 1
const Rejected = 2
```

#### 3. åˆå§‹åŒ–å…¥å£

```ts filename="ReactLazy.js"
function lazyInitializer<T>(payload: Payload<T>): T {
  if (payload._status === Uninitialized) {
    const ctor = payload._result;
    const thenable = ctor();
    thenable.then(
      moduleObject => {
        if (
          (payload: Payload<T>)._status === Pending ||
          payload._status === Uninitialized
        ) {
          const resolved: ResolvedPayload<T> = (payload: any);
          resolved._status = Resolved;
          resolved._result = moduleObject;
        }
      },
      error => {
        if (
          (payload: Payload<T>)._status === Pending ||
          payload._status === Uninitialized
        ) {
          const rejected: RejectedPayload = (payload: any);
          rejected._status = Rejected;
          rejected._result = error;
        }
      },
    );
  }
  if (payload._status === Resolved) {
    const moduleObject = payload._result;
    return moduleObject.default;
  } else {
    throw payload._result;
  }
}
```

#### 4. åŠ è½½æµç¨‹

å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œ`lazy` ç»„ä»¶çš„åŠ è½½æµç¨‹æ˜¯æ ¹æ® `lazyInitializer` ä¸­ `payload` çš„çŠ¶æ€ä»è€Œè¿”å›ç»„ä»¶æˆ–è€…æ˜¯ `throw` ä¸€ä¸ªå¼‚å¸¸å»èµ° `Suspense` æµç¨‹ï¼Œå®Œæˆç»„ä»¶ä¸å¤‡ç”¨ç»„ä»¶çš„æ¸²æŸ“åˆ‡æ¢ã€‚

```ts filename="ReactFiberBeginWork.js"
function mountLazyComponent(
  _current: null | Fiber,
  workInProgress: Fiber,
  elementType: any,
  renderLanes: Lanes
) {
  const props = workInProgress.pendingProps
  const lazyComponent: LazyComponentType<any, any> = elementType
  let Component

  const payload = lazyComponent._payload
  const init = lazyComponent._init
  Component = init(payload)
  workInProgress.type = Component

  // åŠ è½½å®Œæˆçœç•¥
}
```

ä¸‹é¢çš„æµç¨‹å›¾æè¿°äº† `lazy` ç»„ä»¶åœ¨ `beginWork` é˜¶æ®µçš„åŠ è½½è¿‡ç¨‹ï¼š

```mermaid filename="lazy ç»„ä»¶ beginWork æµç¨‹"
graph TD;
  A[beginWork] --> B[mountLazyComponent]
  B --> C[lazyInitializer]
  C --> D{_status?}
  D --> |Resolved ï¼ˆåŠ è½½å®Œæˆï¼‰| E[è¿”å›ç»„ä»¶èµ°æ¸²æŸ“/æ›´æ–°æµç¨‹]
  D --> |å¼‚å¸¸æµç¨‹| F[throw Promise è¿›å…¥ Suspense æµç¨‹]
```

[^1]: [0213-suspense-in-react-18.md](https://github.com/reactjs/rfcs/blob/main/text/0213-suspense-in-react-18.md)

[^2]: [React use](https://zh-hans.react.dev/reference/react/use)
